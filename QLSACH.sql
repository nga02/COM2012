---TAO CSDL
CREATE DATABASE QLSACH
----TẠO BẢNG
----BANG NGANH HOC
IF OBJECT_ID('NGANHHOC') IS NOT NULL
   DROP TABLE NGANHHOC
GO
CREATE TABLE NGANHHOC
(
	MANG  VARCHAR(10)  NOT NULL,
	TENNG NVARCHAR(50) NULL,
	 CONSTRAINT  PK_NGANHHOC PRIMARY KEY(MANG)
)
---BANG LOP HOC
IF OBJECT_ID('LOPHOC') IS NOT NULL
	DROP TABLE LOPHOC
GO
CREATE TABLE LOPHOC
(
	MALOP  VARCHAR(10)  NOT NULL,
	MANG   VARCHAR(10)  NULL,
	TENLOP NVARCHAR(50) NULL,
	CONSTRAINT PK_LOPHOC PRIMARY KEY(MALOP),
	 CONSTRAINT FK_LOPHOC_NGANHHOC FOREIGN KEY (MANG)
	         REFERENCES NGANHHOC
)
---BANG SINH VIEN
IF OBJECT_ID('SINHVIEN') IS NOT NULL
	DROP TABLE SINHVIEN
GO
CREATE TABLE SINHVIEN
(
	MASV VARCHAR(10) NOT NULL,
	MALOP  VARCHAR(10) NULL,
	HOTEN  NVARCHAR(50) NULL,
	DIACHI NVARCHAR(50) NULL,
	EMAIL  VARCHAR(50) NULL,
	SDT VARCHAR(15) NULL,
	NGSINH DATETIME NULL,
	NGHH DATETIME NULL,
	CONSTRAINT PK_SINHVIEN PRIMARY KEY(MASV),
	 CONSTRAINT FK_SINHVIEN_LOPHOC FOREIGN KEY (MALOP)
	         REFERENCES LOPHOC
)
---BANG PHIEU MUON
IF OBJECT_ID('PHIEUMUON') IS NOT NULL
	DROP TABLE PHIEUMUON
GO
CREATE TABLE PHIEUMUON
(
	MAPHIEU VARCHAR(10) NOT NULL,
	MASV VARCHAR(10) NULL,
	NGAYMUON DATETIME NULL,
	CONSTRAINT PK_PHIEU PRIMARY KEY(MAPHIEU),
	CONSTRAINT FK_PHIEUMUON_SINHVIEN FOREIGN KEY (MASV)
			REFERENCES SINHVIEN
)
---BANG THE LOAI
IF OBJECT_ID('THELOAI') IS NOT NULL
	DROP TABLE THELOAI
GO
CREATE TABLE THELOAI
(
	MATL VARCHAR(10) NOT NULL,
	TENTL NVARCHAR(50) NULL,
	CONSTRAINT PK_THELOAI PRIMARY KEY(MATL)
)
-----BANG SACH
IF OBJECT_ID('SACH') IS NOT NULL
	DROP TABLE SACH
GO
CREATE TABLE SACH
(
	MASACH  VARCHAR(10) NOT NULL,
	MATL VARCHAR(10) NULL,
	TIEUDE NVARCHAR(50) NULL,
	SOTRANG INT NULL,
	SLBANSAO INT NULL,
	GIABIA MONEY NULL,
	NGAYNK DATETIME NULL,
	NHAXB NVARCHAR(50) NULL,
	VITRI NVARCHAR(50) NULL,
	NHANXET  NVARCHAR(50) NULL
	CONSTRAINT PK_SACH PRIMARY KEY(MASACH),
	CONSTRAINT FK_SACH_THELOAI FOREIGN KEY (MATL)
			REFERENCES THELOAI
)
---BANG CT PHIEU MUON
IF OBJECT_ID('CTPHIEUMUON') IS NOT NULL
	DROP TABLE CTPHIEUMUON
GO
CREATE TABLE CTPHIEUMUON
(
	MASACH VARCHAR(10) NOT NULL,
	MAPHIEU VARCHAR(10) NOT NULL,
	SOLUONG INT NULL,
	CONSTRAINT FK_CTPHIEUMUON_SACH FOREIGN KEY (MASACH)
			REFERENCES SACH,
	CONSTRAINT FK_CTPHIEUMUON_PHIEUMUON FOREIGN KEY (MAPHIEU)
			REFERENCES PHIEUMUON,
	CONSTRAINT PK_CTPHIEUMUON PRIMARY KEY(MASACH,MAPHIEU)
)
---BANG TAC GIA
IF OBJECT_ID('TACGIA') IS NOT NULL
	DROP TABLE TACGIA
GO
CREATE TABLE TACGIA
(	
	MATG VARCHAR(10) NOT NULL,
	HOTEN NVARCHAR(30) NULL,
	BUTDANH NVARCHAR(50) NULL,
	DIACHI NVARCHAR(50) NULL,
	SDT VARCHAR(15) NULL,
	CONSTRAINT PK_TACGIA PRIMARY KEY(MATG)
)
---BANG SACHTG
IF OBJECT_ID('SACHTG') IS NOT NULL
	DROP TABLE SACHTG
GO
CREATE TABLE SACHTG
(
	MASACH VARCHAR(10) NOT NULL,
	MATG VARCHAR(10) NOT NULL,
	CONSTRAINT FK_SACHTG_SACH FOREIGN KEY (MASACH)
			REFERENCES SACH,
	CONSTRAINT FK_SACHTG_TACGIA FOREIGN KEY (MATG)
			REFERENCES TACGIA,
	CONSTRAINT PK_SACHTG PRIMARY KEY(MASACH,MATG)
)
---CHEN DU LIEU
---BANG NGANH HOC
DELETE FROM NGANHHOC
INSERT INTO NGANHHOC VALUES
	('UD',N'ỨNG DỤNG PHẦN MỀM'),
	('IT',N'CÔNG NGHỆ THÔNG TIN'),
	('KD',N'QUẢN TRỊ KINH DOANH'),
	('DL',N'DU LỊCH-NHÀ HÀNG-KHÁCH SẠN'),
	('DH',N'ĐỒ HỌA'),
	('CB',N'CƠ BẢN')
---BANG LOP HOC
DELETE FROM LOPHOC
INSERT INTO LOPHOC VALUES
	('PT17301','UD','PT17301-UD'),
	('PT17302','UD','PT17302-UD'),
	('PT17311','IT','PT17311-WE'),
	('PT17321','IT','PT17301-MOB'),
	('PT17331','IT','PT17331-WEB'),
	('PT17329','IT','PT17329-UD'),
	('PT17333','UD','PT17333-MOB'),
	('PT17328','IT','PT17328-WEB'),
	('PT17325','UD','PT17325-UD'),
	('PT17327','IT','PT17327-MOB')
----BANG SINH VIEN
DELETE FROM SINHVIEN
INSERT INTO SINHVIEN VALUES
	('PH26840','PT17329',N'LÊ THỊ NGA',N'THANH HÓA', 'NGALTPH26840@FPT.EDU.VN','0358475868','4/20/2003','12/31/2022'),
	('PH26841','PT17327',N'LÊ NGỌC MAI',N'THÁI BÌNH','MAINL@FPT.EDU.VN','0358475674','7/15/2003','12/31/2022'),
	('PH26842','PT17331',N'LÊ THỊ TRANG',N'HÀ NỘI', 'TRANG@FPT.EDU.VN','03584786486','6/25/2003','12/31/2022'),
	('PH26569','PT17321',N'BÙI TRÚC QUỲNH',N'VĨNH PHÚC', 'QUYNH@FPT.EDU.VN','03563847586','12/14/2003','12/31/2022'),
	('PH26876','PT17327',N'LÊ HOÀI THU',N'NGHỆ AN', 'THU@FPT.EDU.VN','03584758693','8/29/2003','12/31/2022'),
	('PH26787','PT17333',N'HÀ NGỌC ANH',N'THÁI BÌNH', 'ANH@FPT.EDU.VN','03584758627','9/24/2003','12/31/2022'),
	('PH26785','PT17301',N'HÀ THỊ NHÀN ',N'NAM ĐỊNH', 'NHAN@FPT.EDU.VN','03584758635','10/13/2003','12/31/2022'),
	('PH26843','PT17302',N'LÊ MAI ANH',N'HẢI PHÒNG', 'ANHML@FPT.EDU.VN','03584758642','5/18/2003','12/31/2022'),
	('PH26846','PT17311',N'TRƯƠNG THỊ LINH',N'LẠNG SƠN', 'LINHTT@FPT.EDU.VN','03584758676','4/16/2003','12/31/2022'),
	('PH26849','PT17325',N'LÊ NGỌC LINH',N'HÒA BÌNH', 'LINHNT@FPT.EDU.VN','03584758658','8/26/2003','12/31/2022')
----BANG PHIEU MUON
DELETE FROM PHIEUMUON
INSERT INTO PHIEUMUON VALUES
	('CS456','PH26840','1/25/2022'),
	('CS457','PH26841','2/20/2022'),
	('CS458','PH26569','5/15/2022'),
	('CS459','PH26849','3/27/2022'),
	('CS436','PH26876','4/20/2022'),
	('CS476','PH26842','7/14/2022'),
	('CS486','PH26843','8/18/2022'),
	('CS956','PH26846','3/10/2022'),
	('CS356','PH26842','2/23/2022'),
	('CS426','PH26843','1/26/2022')
----BANG THE LOAI
DELETE FROM THELOAI
INSERT INTO THELOAI VALUES
	('KT',N'KINH TẾ'),
	('IT',N'CÔNG NGHỆ THÔNG TIN'),
	('EN',N'TIẾNG ANH'),
	('DH',N'ĐỒ HỌA'),
	('KS',N'KHÁCH SẠN')
----BANG SACH
DELETE FROM SACH
INSERT INTO SACH VALUES
	('A235','KT',N'QUỐC GIA KHỞI NGHIỆP',18500,100,320000,'2/20/2018',N'NHÀ XUẤT BẢN TRẺ',N'VIỆT NAM',N'BỔ ÍCH'),
	('A246','IT',N'CODE DẠO KÍ TỰ',3500,200,330000,'2/20/2019',N'NHÀ XUẤT DÂN TRÍ',N'VIỆT NAM',N'BỔ ÍCH'),
	('A237','KT',N'BONG BÓNG KINH TẾ',7500,150,420000,'2/20/2018',N'NHÀ XUẤT BẢN TRẺ',N'VIỆT NAM',N'HAY'),
	('A238','DH',N'THIẾT KẾ',1800,120,520000,'2/20/2020',N'NHÀ XUẤT BẢN TRẺ',N'VIỆT NAM',N'THÚ VỊ'),
	('A245','EN',N'HACK NÃO',1700,90,360000,'2/20/2021',N'NHÀ XUẤT BẢN TRẺ',N'VIỆT NAM',N'BỔ ÍCH'),
	('A258','KT',N'TẦM NHÌN THAY ĐỔI QUỐC GIA',1800,140,453000,'2/20/2020',N'NHÀ XUẤT BẢN TRẺ',N'VIỆT NAM',N'Ý NGHĨA'),
	('A273','IT',N'LẬP TRÌNH VÀ CUỘC SỐNG',1500,130,289000,'2/20/2017',N'NHÀ XUẤT BẢN BÁCH KHOA',N'VIỆT NAM',N'BỔ ÍCH'),
	('A248','KS',N'ĐẦU TƯ VÀ KINH DOANH KHÁCH SẠN',15400,160,356000,'2/20/2016',N'NHÀ XUẤT BẢN TRẺ',N'VIỆT NAM',N'BỔ ÍCH'),
	('A259','IT',N'GIÁO TRÌNH C++',12600,170,435000,'2/20/2018',N'NHÀ XUẤT BẢN BÁCH KHOA HÀ NỘI',N'VIỆT NAM',N'HAY'),
	('A268','EN',N'TIẾNG ANH THƯƠNG MẠI',18800,180,340000,'2/20/2019',N'NHÀ XUẤT BẢN ĐẠI HỌC QUỐC GIA',N'VIỆT NAM',N'BỔ ÍCH')
----BANG CTPHIEUMUON
DELETE FROM CTPHIEUMUON
INSERT INTO CTPHIEUMUON VALUES
	('A235','CS456',1),
	('A237','CS426',2),
	('A259','CS457',3),
	('A246','CS458',4),
	('A273','CS459',2),
	('A248','CS436',3),
	('A258','CS476',4),
	('A245','CS486',3),
	('A268','CS356',2)
----BANG TACGIA
DELETE FROM TACGIA
INSERT INTO TACGIA VALUES
	('T21',N'HOÀNG ANH TUẤN',N'TUẤN HOÀNG',N'NINH BÌNH','0984526856'),
	('T22',N'TRẦN ANH KHOA',N'KHOA TRẦN',N'THÁI  BÌNH','0984526824'),
	('T23',N'NGUYỄN HOÀI NAM',N'TUẤN NAM',N'HÒA BÌNH','0984526832'),
	('T24',N'HÀ TRỌNG ANH',N'ANH HÀ',N'QUẢNG BÌNH','0984526846'),
	('T25',N'MAI VĂN NGỌC',N'MAI NGỌC',N'BÌNH ĐỊNH','0984526875')
----BANG SACHTG
DELETE FROM SACHTG
INSERT INTO SACHTG VALUES
	('A235','T21'),
	('A237','T22'),
	('A259','T23'),
	('A246','T24'),
	('A248','T25')



----TRUY VAN
SELECT * FROM NGANHHOC
SELECT * FROM LOPHOC
SELECT * FROM SINHVIEN
SELECT * FROM PHIEUMUON
SELECT * FROM CTPHIEUMUON
SELECT * FROM SACH
SELECT * FROM THELOAI
SELECT * FROM TACGIA
SELECT * FROM SACHTG
/*6.1 Liệt kê tất cả thông tin của các đầu sách gồm tên sách, mã sách, giá tiền , tác giả 
thuộc loại sách có mã “IT” */
SELECT TIEUDE,SACH.MASACH,GIABIA,MATG,MATL
FROM SACH JOIN SACHTG ON SACH.MASACH=SACHTG.MASACH
WHERE MATL ='IT'
/*6.2 Liệt kê các phiếu mượn gồm các thông tin mã phiếu mượn, mã sách , ngày mượn, mã 
sinh viên có ngày mượn trong tháng 01/2017. */
SELECT PHIEUMUON.MAPHIEU,MASACH,NGAYMUON,MASV
FROM PHIEUMUON JOIN CTPHIEUMUON ON PHIEUMUON.MAPHIEU = CTPHIEUMUON.MAPHIEU
WHERE MONTH(NGAYMUON) = 2 AND YEAR(NGAYMUON) = 2022
---6.3 Liệt kê các phiếu mượn chưa trả sách cho thư viên theo thứ tự tăng dần của ngày 

 ---KHI THIEEUS COT,MUON THEM COT VAO BANG
 ALTER TABLE PHIEUMUON
 ADD TRANGTHAI NVARCHAR(30) NULL
 DEFAULT N'CHƯA TRẢ SÁCH' WITH VALUES
 -----TRUY VẤN 6.3
 SELECT * FROM PHIEUMUON
 WHERE TRANGTHAI LIKE N'CHƯA%' AND NGAYMUON IS NOT NULL
 ORDER BY NGAYMUON ASC
 -----6.4 Liệt kê tổng số đầu sách của mỗi loại sách ( gồm mã loại sách, tên loại sách, tổng số lượng sách mỗi loại).
 SELECT THELOAI.MATL,TENTL,COUNT(SACH.MATL) AS SOLOAI
 FROM THELOAI JOIN SACH ON THELOAI.MATL =SACH.MATL
 GROUP BY THELOAI.MATL,TENTL
 ----6,5  Đếm xem có bao nhiêu lượt sinh viên đã mượn sách.
 SELECT COUNT(MASV) AS SOLUOTSV
 FROM PHIEUMUON

 -----6.6 /*Hiển thị tất cả các quyển sách có tiêu đề chứa từ khoá “SQL”.*/
 SELECT * FROM SACH
 WHERE TIEUDE LIKE N'SQL%' 
 -----6.7
 /*Hiển thị thông tin mượn sách gồm các thông tin: mã sinh viên, tên sinh viên, mã 
 phiếu mượn, tiêu đề sách, ngày mượn, ngày trả. Sắp xếp thứ tự theo ngày mượn sách.*/
 SELECT SINHVIEN.MASV,HOTEN,PHIEUMUON.MAPHIEU,TIEUDE,NGAYMUON, GETDATE() AS NGAYTRA
 FROM SINHVIEN JOIN PHIEUMUON ON SINHVIEN.MASV = PHIEUMUON.MASV
			  JOIN CTPHIEUMUON ON PHIEUMUON.MAPHIEU = CTPHIEUMUON.MAPHIEU
			  JOIN SACH ON SACH.MASACH = CTPHIEUMUON.MASACH
WHERE NGAYMUON IS NOT NULL
ORDER BY NGAYMUON ASC

-----6.8 /* Liệt kê các đầu sách có lượt mượn lớn hơn 20 lần KHONG RA */
SELECT MASACH, COUNT(MASACH) AS SOLUOT 
FROM CTPHIEUMUON
GROUP BY MASACH
HAVING COUNT (MASACH) > 3

----6.9
/*Viết câu lệnh cập nhật lại giá tiền của các quyển sách có ngày nhập kho trước năm 
2019 giảm 30%.*/
------CAP NHAT DU LIEU
/*UPDATE <TENBANG>
SET <TENCOT> = < <GTRI>
[WHERE DK]*/
UPDATE SACH 
SET GIABIA = GIABIA * 0.7
WHERE YEAR(NGAYNK) < 2018
SELECT * FROM SACH
---6.10
/*Viết câu lệnh cập nhật lại trạng thái đã trả sách cho phiếu mượn của sinh viên có mã 
sinh viên PD12301 (ví dụ). */
UPDATE PHIEUMUON
SET TRANGTHAI = N'ĐÃ TRẢ SÁCH'
WHERE MASV = 'PH26876'
SELECT * FROM PHIEUMUON
---6.11
/*Lập danh sách các phiếu mượn quá hạn chưa trả gồm các thông tin: mã phiếu mượn, 
tên sinh viên, email, danh sách các sách đã mượn, ngày mượn*/
SELECT PHIEUMUON.MAPHIEU,HOTEN,EMAIL,NGAYMUON,MASACH
FROM PHIEUMUON JOIN SINHVIEN ON PHIEUMUON.MASV = SINHVIEN.MASV
    JOIN CTPHIEUMUON ON PHIEUMUON.MAPHIEU = CTPHIEUMUON.MAPHIEU
WHERE GETDATE () - NGAYMUON - 1 > 7
----6.12
/*Viết câu lệnh cập nhật lại số lượng bản sao tăng lên 5 đơn vị đối với các đầu sách có 
lượt mượn lớn hơn 10*/
UPDATE SACH
SET SLBANSAO = SLBANSAO + 5
WHERE MASACH IN (SELECT MASACH FROM CTPHIEUMUON
				GROUP BY MASACH
				HAVING COUNT (MASACH) > 5)
SELECT * FROM SACH
--6.13 /LOI /
/*Viết câu lệnh xoá các phiếu mượn có ngày mượn và ngày trả trước „1/1/2010*/
---TẠO RA BẢNG MỚI ĐỂ XÓA KHONG ẢNH HƯỞNG ĐẾN BANGE ĐÃ CÓ 

SELECT * INTO PMMOI FROM PHIEUMUON
SELECT * INTO CTPMMOI FROM CTPHIEUMUON
-------TRUY VẤN
SELECT * FROM PMMOI
SELECT * FROM CTPMMOI
--------XÓA FK TRƯỚC VÀ PK SAU 
DELETE FROM CTPMMOI
WHERE MAPHIEU IN (SELECT MAPHIEU FROM PMMOI
				WHERE NGAYMUON < '02/11/2022')
DELETE FROM PMMOI
WHERE NGAYMUON < '02/11/2022'