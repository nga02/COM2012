CREATE DATABASE BUOI2
-------BẢNG LOAIPHONG
IF OBJECT_ID('LOAIPHONG') IS NOT NULL
DROP TABLE LOAIPHONG
GO
CREATE TABLE LOAIPHONG
(
	MA_PH VARCHAR(10) NOT NULL,
	TEN_PHONG NVARCHAR(50) NULL,
	DON_GIA MONEY NULL,
	CONSTRAINT PK_LOAIPHONG PRIMARY KEY(MA_PH)
)
-------BẢNG KHACHHANG
IF OBJECT_ID('KHACHHANG') IS NOT NULL
DROP TABLE KHACHHANG
GO
CREATE TABLE KHACHHANG
(
	MA_KH VARCHAR(10) NOT NULL,
	TEN_KH NVARCHAR(50) NULL,
	MA_PH VARCHAR(10) NOT NULL,
	NGAY_THUE DATE NULL,
	NGAY_TRA DATE NULL,
	CONSTRAINT PK_KHACHHANG PRIMARY KEY (MA_KH),
	CONSTRAINT FK_LOAIPHONG_KHACHHANG FOREIGN KEY(MA_PH) REFERENCES LOAIPHONG
)
--------BẢNG DICHVU
IF OBJECT_ID('DICHVU') IS NOT NULL
DROP TABLE DICHVU
GO
CREATE TABLE DICHVU
( 
	MA_PH VARCHAR(10) NOT NULL,
	MA_KH VARCHAR(10) NOT NULL,
	NGAY DATE NULL,
	TIEN_DV MONEY NULL,
	TEN_DV NVARCHAR(50) NOT NULL,
	CONSTRAINT PK_DICHVU PRIMARY KEY (MA_PH,MA_KH),
	CONSTRAINT FK_LOAIPHONG_DICHVU FOREIGN KEY(MA_PH) REFERENCES LOAIPHONG,
	CONSTRAINT FK_KHACHHANG_DICHVU FOREIGN KEY(MA_KH) REFERENCES KHACHHANG
)
-----NHẬP DL
---BẢNG LOAIPHONG
DELETE FROM LOAIPHONG 
INSERT INTO LOAIPHONG VALUES 
			('PH01',N'PHÒNG ĐƠN',500000),
			('PH02',N'PHÒNG ĐÔI',700000),
			('PH03',N'PHÒNG VIP',1000000)
--BẢNG KHACHHANG
DELETE FROM KHACHHANG
INSERT INTO KHACHHANG VALUES 
			('KH01',N'LÊ VĂN NGHĨA','PH01','2/5/2020','2/17/2020'),
			('KH02',N'NGUYỄN THỊ LAN','PH02','1/12/2020','1/18/2020'),
			('KH03',N'LÊ THỊ NGA','PH02','1/22/2020','1/30/2020')
---BẢNG DICHVU
DELETE FROM DICHVU
INSERT INTO DICHVU VALUES 
			('PH01','KH01','2/16/2020',30000,N'GIẶT ỦI'),
			('PH02','KH02','1/17/2020',10000,N'ĐIỂM TÂM'),
			('PH02','KH03','1/18/2020',20000,N'ĐIỆN THOẠI')
SELECT * FROM LOAIPHONG
SELECT * FROM KHACHHANG
SELECT * FROM DICHVU
------TRUY VẤN
/*Câu 2. Viết lệnh SQL hiển thị thông tin: tenkh, tenphong, ngaythue, ngaytra,
songaythue, dongia, tienphong. Trong đó tienphong = songaythue * dongia*/
SELECT TEN_KH, TEN_PHONG, NGAY_THUE,NGAY_TRA, DATEDIFF(DAY,NGAY_THUE,NGAY_TRA) AS SO_NGAY_THUE,
DON_GIA,DATEDIFF(DAY,NGAY_THUE,NGAY_TRA)*DON_GIA AS TIENPHONG
FROM KHACHHANG JOIN LOAIPHONG ON LOAIPHONG.MA_PH=KHACHHANG.MA_PH

/*Câu 3. Tìm thông tin các khách hàng có họ là ‘Lê’ và thuê phòng trong tháng 2 
năm 2020. Hiển thi kết quả có các trường: tenkh, maphong, ngaythue, ngaytra */
SELECT TEN_KH,LOAIPHONG.MA_PH,NGAY_THUE,NGAY_TRA 
FROM KHACHHANG JOIN LOAIPHONG ON LOAIPHONG.MA_PH=KHACHHANG.MA_PH
WHERE TEN_KH LIKE N'LÊ %' AND MONTH(NGAY_THUE) = 2

/*Câu 4. Viết lệnh SQL để liệt kê ra các khách có số ngày ở lớn nhất của mỗi phòng. 
Kết quả hiển thị có các trường sau: Tên khách hàng, Mã phòng, tên phòng và số ngày ở. */
SELECT TEN_KH,LOAIPHONG.MA_PH,TEN_PHONG, MAX(DATEDIFF(DAY,NGAY_THUE,NGAY_TRA)) 
FROM KHACHHANG JOIN LOAIPHONG ON LOAIPHONG.MA_PH=KHACHHANG.MA_PH
GROUP BY TEN_KH,LOAIPHONG.MA_PH,TEN_PHONG

/*Câu 5. Tìm các phòng chưa có khách thuê từ tháng 1 năm 2020. Hiển thị các 
thông tin: Maphong, tenphong, dongia*/
SELECT MA_PH,TEN_PHONG,DON_GIA 
FROM LOAIPHONG 
WHERE NOT EXISTS ( SELECT MA_PH,TEN_PHONG,DON_GIA FROM KHACHHANG
				 WHERE KHACHHANG.MA_PH=LOAIPHONG.MA_PH AND NGAY_THUE > '1/1/2020' )

/*CAU 6	Chèn thêm một bản ghi mới  vào bảng DICHVU không chứa giá trị null. (1 điểm)*/
INSERT INTO DICHVU VALUES ('PH03','KH03','2/15/2020',30000,N'GIẶT ỦI')
/*CAU 7	Xóa những khách thuê phòng trước ngày 01/01/2020. (1 */
DELETE FROM KHACHHANG
WHERE NGAY_THUE < '1/1/2020'

/*CAU 8	Giảm 50% đơn giá cho các phòng là “phòng đôi”  (1 điểm)*/
UPDATE LOAIPHONG SET DON_GIA= DON_GIA * 0.5 WHERE TEN_PHONG = N'PHÒNG ĐÔI'