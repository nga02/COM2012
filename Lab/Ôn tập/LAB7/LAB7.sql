----TAO CSDL
CREATE DATABASE LAB7
----BẢNG MATHANG
IF OBJECT_ID('MATHANG') IS NOT NULL
  DROP TABLE MATHANG
GO
CREATE TABLE MATHANG
(
	MA_HANG VARCHAR(10) NOT NULL,
	TEN_HANG NVARCHAR(50) NULL,
	DON_GIA MONEY NULL,
	CONSTRAINT PK_MATHANG PRIMARY KEY(MA_HANG)
)
-----BANG KHACHHANG
IF OBJECT_ID(' KHACHHANG') IS NOT NULL
  DROP TABLE  KHACHHANG
GO
CREATE TABLE  KHACHHANG
(
	MA_KH VARCHAR(10) NOT NULL,
	TEN_KH NVARCHAR(50) NULL,
	GIOITINH NVARCHAR(10) NULL,
	QUEQUAN NVARCHAR(50) NULL,
	CONSTRAINT PK_KHACHHANG PRIMARY KEY(MA_KH),
)
---------BANG HOADON
IF OBJECT_ID('HOADON') IS NOT NULL
  DROP TABLE  HOADON
GO
CREATE TABLE  HOADON
(
	MA_PHIEU VARCHAR(10) NOT NULL,
	NGAYLAP DATE NULL,
	MA_KH VARCHAR(10) NOT NULL,
	CONSTRAINT PK_HOADON PRIMARY KEY (MA_PHIEU),
	CONSTRAINT FK_HOADON_KHACHHANG FOREIGN KEY(MA_KH)
				REFERENCES KHACHHANG
)
---------BANG HOADONCT
IF OBJECT_ID('HOADONCT') IS NOT NULL
  DROP TABLE  HOADONCT
GO
CREATE TABLE  HOADONCT
(
	MA_PHIEU VARCHAR(10) NOT NULL,
	MA_HANG VARCHAR(10) NOT NULL,
	SLUONG   INT NULL,
	CONSTRAINT PK_HOADONCT PRIMARY KEY (MA_PHIEU,MA_HANG),
	CONSTRAINT FK_HOADONCT_HOADON FOREIGN KEY(MA_PHIEU)
				REFERENCES HOADON,
	CONSTRAINT FK_HOADONCT_MATHANG FOREIGN KEY(MA_HANG)
				REFERENCES MATHANG
)
-----NHAP DU LIEU
---BANG MATHANG
DELETE FROM MATHANG
INSERT INTO MATHANG VALUES
	 ('M1',N'DƯỠNG MÔI OHUI',200000),
     ('M2',N'TINH CHẤT OHUI',1000000),
     ('M3',N'KEM DƯỠNG OHUI',550000)
---BANG KHACHHANG
DELETE FROM KHACHHANG
INSERT INTO KHACHHANG VALUES
	('K1',N'TRẦN TRIỆU VY',N'NỮ',N'HÀ NỘI'),
	('K2',N'TRẦN ĐÌNH TRỌNG',N'NAM',N'THÁI BÌNH'),
    ('K3',N'MINH HÀ',N'NỮ',N'SÀI GÒN')
---BANG HOADON
DELETE FROM HOADON
INSERT INTO HOADON VALUES
	('P1','3/3/2019','K1'),
    ('P2','8/3/2019','K1'),
    ('P3','8/4/2019','K3')
---BANG HOADONCT
DELETE FROM HOADONCT
INSERT INTO HOADONCT VALUES
	('P1','M1',2),
    ('P1','M2',3),
    ('P2','M2',1)
SELECT * FROM MATHANG
SELECT * FROM KHACHHANG
SELECT * FROM HOADON
SELECT * FROM HOADONCT

------THUC HIEN TRUY VAN
/*Câu 2: Đưa ra thông tin: Makh, Tenkh, Gioitinh của những khách hàng có Họ TRẦN và Quequan là ‘THÁI BÌNH’. */
SELECT MA_KH,TEN_KH,GIOITINH 
FROM KHACHHANG 
WHERE TEN_KH LIKE N'TRẦN%' AND QUEQUAN LIKE N'THÁI BÌNH'

/*Câu 3: Đưa ra thông tin danh sách các khách hàng (Makh, Tenkh, tổng tiền)
có tổng thành tiền  của các hóa đơn từ 1.000.000 trở lên. 
Trong đó tổng tiền=số lượng*Đơn giá */
SELECT KHACHHANG.MA_KH,TEN_KH,SUM(SLUONG * DON_GIA) AS TONGTIEN
FROM KHACHHANG JOIN HOADON ON HOADON.MA_KH=KHACHHANG.MA_KH
				JOIN HOADONCT ON HOADONCT.MA_PHIEU=HOADON.MA_PHIEU      /*XEM LẠI*/
				JOIN MATHANG ON MATHANG.MA_HANG=HOADONCT.MA_HANG
GROUP  BY KHACHHANG.MA_KH,TEN_KH
HAVING SUM(SLUONG * DON_GIA) >=1000000
/*Câu 4: Cho biết thông tin khách hàng chưa đặt đơn hàng nào.
Thông tin gồm: Makh, Tenkh (1đ)*/
SELECT MA_KH,TEN_KH FROM KHACHHANG 
WHERE NOT EXISTS(SELECT MA_KH,TEN_KH FROM HOADON                    /*XEM LẠI*/
				WHERE KHACHHANG.MA_KH=HOADON.MA_KH)
/*Câu 5: Liệt kê thông tin: Makh, Tenkh, Mahang, Tenhang, Dongia, Soluong
của khách hàng có tên khách hàng là Trần Triệu Vy . (1đ)*/
SELECT KHACHHANG.MA_KH,TEN_KH,MATHANG.MA_HANG,TEN_HANG,DON_GIA,SLUONG 
FROM KHACHHANG JOIN HOADON ON HOADON.MA_KH=KHACHHANG.MA_KH
				JOIN HOADONCT ON HOADONCT.MA_PHIEU=HOADON.MA_PHIEU                   /*XEM LẠI*/
				JOIN MATHANG ON MATHANG.MA_HANG=HOADONCT.MA_HANG
WHERE TEN_KH = N'TRẦN TRIỆU VY'
/*Câu 6: Thêm một bản ghi mới vào chitiethoadon,dữ liệu phù hợp( không được nhập giá trị null). */
INSERT INTO HOADONCT VALUES  ('P3','M3',2)
/*Câu 7: Thay đổi quê quán của khách hàng Minh Hà thành ‘Miền Tây’ */
UPDATE KHACHHANG SET QUEQUAN = N'MIỀN TÂY'
WHERE TEN_KH = N'MINH HÀ'
/*Câu 8: Xóa mặt hàng có tên hàng ‘Kem dưỡng Ohui’ */
---XÓA KHÓA NGOẠI TRƯỚC
DELETE FROM HOADONCT
WHERE MA_HANG='M3'
--------XÓA KHÓA CHÍNH SAU
DELETE FROM MATHANG
WHERE MA_HANG = 'M3'